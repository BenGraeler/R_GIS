#' Developing a script that enables a tool to run the ordinary kriging
#'
#' This script function builds an interpolated result without taking into account of the covariates
#' and provide a kriged plot upon being run with the corresponding ArcGIS script tool.
#'
#'\code{tool_exec}
#' @param in_params - input parameters
#' @param out_params - output parameters
#' @param input_feature -  Input point feature containing fields of the dependant variable and all explanatory variables.
#' @param predict_location -  Input point feature representing locations where you would like to predict the probable values for the presence of dependant variable. These point feature must have certain explanatory variables stored as fields.
#' @param dep_variable - Field from the input feature containing the sampled attributes. A particular value gives the strength of the field element at that point.
#' @param log_var - Taking logarithmic values for the dependent variable.
#' @param partial_sill - (Partial) Sill of the variogram model component.
#' @param modl - Model type, e.g. "Exp", "Sph", "Gau", "Mat".
#' @param rang - Range of the variogram model component.
#' @param nugt - Nugget component of the variogram. (this basically adds a nugget compontent to the model)
#' @return output_feature1 - Output krige shapefile that contains the predictions of the values of unsampled locations from the Prediction_location dataset.
#' @return output_feature2 - Output variance provides how far the values are deviated from the other and the mean and exports the output as a pdf file.
#' @author Shankarlingam Sundaresan
#' @details This script function interpolates the values that are modeled by a Gaussian process governed by prior covariance,
#' as opposed to a piecewiseâ€“polynomial spline chosen to optimize smoothness of the fitted values.
#' it is particularly associated with linear unbiased estimation, as the estimations are weighed linear combination of available data.
#' It does not take into account of the covariates
#' i.e. it assumes constant unknown mean and helps in minimizing error variance.
#' @export
#'



# Ordinary kriging
# Initializing binding tool function
tool_exec <- function(in_params, out_params)
{
  # loading packages



  if (!requireNamespace("sp", quietly = T))
    install.packages("sp")
  if (!requireNamespace("gstat",quietly = T))
    install.packages("gstat")
  if (!requireNamespace("raster",quietly = T))
    install.packages("raster")


  require(sp)
  require(gstat)
  require(raster)

  # defining variables
  input_feature = in_params[[1]]
  predict_location = in_params[[2]]
  partial_sill = in_params[[5]]
  modl = in_params[[6]]
  rang = in_params[[7]]
  nugt = in_params[[8]]
  dep_variable = in_params[[3]]
  output_feature1 = out_params[[1]]
  output_feature2 = out_params[[2]]
  log_var = in_params[[4]]

  #exporting datasets
  d = arc.open(input_feature)
  dat = arc.select(d, names(d@fields))
  dat.2 = arc.data2sp(dat)

  #creating model formula
  message("Creating model formula")

  if (log_var == FALSE)
  {
    model_kr = paste(dep_variable, "~1")
    message("formula =",model_kr)
  }
  else
  {
    model_kr = paste(paste ("log(",dep_variable,")"),paste("~1"))
    message("formula = log(",dep_variable,")~1")
  }
  model_kr.f = as.formula(model_kr)

  #creating variogram
  message("computing sample variogram...")
  out_varianc = variogram(model_kr.f,dat.2)

  message("fitting variogram model...")

  #fitting the model
  vario.fit = fit.variogram(out_varianc, vgm(partial_sill, modl, rang, nugt))
  print(vario.fit)


  message("Predicting...")
  d.loc = arc.open(predict_location)
  data.loc = arc.select(d.loc,names(d.loc@fields))
  data.loc.1 =  arc.data2sp(data.loc)
  gridded(data.loc.1)=T

  #### Write Output ####

  message("....kriging now....")
  out_krig = krige(model_kr.f,dat.2, data.loc.1, vario.fit)

  gridded(out_krig)=T
  out_krig1 = out_krig[1]

  gridded(out_krig)=F
  out_krig2 = out_krig[2]

  message("...writing output...")
  arc.write(output_feature1,out_krig1, shape_info = d@shapeinfo)

  if (!is.null(output_feature2))
  {
    pdf(output_feature2)
    print(plot(out_varianc,vario.fit,main = "Variogram with fitted Model",cex.main = 1.25))
    gridded(out_krig)=TRUE
    print(spplot(out_krig))
    gridded(out_krig1)=T
    gridded(out_krig2)=T
    KrigRaster = raster(out_krig1)
    VarRaster = raster(out_krig2)
    plot(KrigRaster,main = "Interpolation Raster Plot",cex.main = 1.5)
    plot(VarRaster,main = "Variance Raster Plot", cex.main =  1.5)
    dev.off()
  }
  message("...done...almost...")
  return(out_params)
}
